<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“æ¨‚é€šè¨Š POS ç³»çµ± - 2026 æ­£å¼ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --pinle-green: #2ecc71; 
            --pinle-blue: #3498db; 
            --pinle-orange: #e67e22;
            --bg-gray: #f4f7f6; 
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg-gray); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        
        #reminder-bar { 
            display:none; background:#fff3cd; color:#856404; padding:15px; 
            text-align:center; font-weight:bold; border:1px solid #ffeeba; 
            border-radius:12px; margin-bottom:20px; 
        }

        .main-flex { display: flex; gap: 20px; align-items: flex-start; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; padding-left: 10px; border-left: 5px solid var(--pinle-green); }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: #4a5568; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .result-box { background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e0; margin-bottom: 15px; }
        .result-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .profit-value { color: var(--pinle-orange); font-weight: 800; font-size: 1.1rem; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; }
        .btn-pay { background: var(--pinle-green); }
        .btn-pay:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-order { background: var(--pinle-orange); }
        .btn-query { background: var(--pinle-blue); }

        .scroll-area { max-height: 350px; overflow-y: auto; margin-top: 15px; border: 1px solid #edf2f7; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f7fafc; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; }

        @media (max-width: 850px) { .main-flex { flex-direction: column; } }
    </style>
</head>
<body onload="initSystem()">

<div class="container">
    <h2>å“æ¨‚é€šè¨Šå°å¹«æ‰‹ 2026</h2>
    <div id="reminder-bar">ğŸ“… æ˜æ—¥å–è²¨æé†’ï¼š<span id="reminder-text"></span></div>

    <div class="main-flex">
        <div class="card">
            <div class="card-title">ğŸ’° å¿«é€Ÿçµå¸³</div>
            <div class="input-group">
                <label>æƒæåºè™Ÿ / SN</label>
                <input type="text" id="sale-sn" placeholder="è«‹æƒæåºè™Ÿ..." oninput="fetchStockData()">
            </div>

            <div class="result-box">
                <div class="result-line"><span>å“åï¼š</span><span id="res-name" style="font-weight:bold;">ç­‰å¾…è¼¸å…¥</span></div>
                <div class="result-line"><span>é€²è²¨æˆæœ¬ï¼š</span><span id="res-cost">$0</span></div>
                <div class="result-line"><span>é ä¼°æ¯›åˆ©ï¼š</span><span id="res-profit" class="profit-value">$0</span></div>
                <small id="fee-note" style="color:#718096;">(å…æ‰‹çºŒè²»æ–¹å¼)</small>
            </div>

            <div class="input-group"><label>è³¼è²·äººå§“å</label><input type="text" id="cust-name" placeholder="å®¢æˆ¶åç¨±"></div>
            <div class="input-group"><label>æˆäº¤å”®åƒ¹</label><input type="number" id="sale-price" placeholder="è¼¸å…¥å”®åƒ¹" oninput="uiCalculate()"></div>
            <div class="input-group">
                <label>æ”¯ä»˜æ–¹å¼</label>
                <select id="pay-method" onchange="uiCalculate()">
                    <option value="ç¾é‡‘">ç¾é‡‘</option>
                    <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                    <option value="iPass Money">iPass Money</option>
                    <option value="åˆ·å¡">åˆ·å¡ (2%)</option>
                    <option value="LP">LP (2%)</option>
                    <option value="åˆ†æœŸ">åˆ†æœŸ (2%)</option>
                    <option value="ç„¡å¡åˆ†æœŸ">ç„¡å¡åˆ†æœŸ (2%)</option>
                    <option value="è¡Œå‹•æ”¯ä»˜">è¡Œå‹•æ”¯ä»˜ (2%)</option>
                </select>
            </div>
            <div class="input-group"><label>æ”¶å…¥é¡åˆ¥</label><select id="income-type"><option value="è¼‰å…¥ä¸­...">è¼‰å…¥ä¸­...</option></select></div>
            <div class="input-group"><label>æ‰¿è¾¦äºº</label><select id="staff"><option value="å¤éœ–">å¤éœ–</option><option value="æ€ç’‡">æ€ç’‡</option><option value="å˜‰å°¹">å˜‰å°¹</option></select></div>
            <div class="input-group"><label>å‚™è¨» (åŠ è´ˆ/å…¶ä»–)</label><input type="text" id="sale-note" placeholder="ä¾‹å¦‚ï¼šé€ä¿è­·è²¼"></div>
            
            <button id="btn-checkout" class="btn btn-pay" onclick="submitCheckout()">ç¢ºèªçµå¸³ä¸¦åŒæ­¥ Excel</button>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
            <div class="card">
                <div class="card-title" style="border-left-color: var(--pinle-orange);">ğŸ“¦ å•†å“å®¢è¨‚</div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-group" style="flex:1;"><label>å®¢æˆ¶</label><input type="text" id="ord-name"></div>
                    <div class="input-group" style="flex:2;"><label>å“å</label><input type="text" id="ord-product"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="input-group" style="flex:1;"><label>è¨‚å–®æ—¥æœŸ</label><input type="date" id="ord-date"></div>
                    <div class="input-group" style="flex:1;"><label>é è¨ˆå–è²¨</label><input type="date" id="ord-pickup"></div>
                </div>
                <div class="input-group"><label>å‚™è¨»</label><input type="text" id="ord-note"></div>
                <button class="btn btn-order" onclick="submitOrder()">å„²å­˜å®¢è¨‚ä¸¦é€šçŸ¥ LINE</button>
            </div>

            <div class="card">
                <div class="card-title" style="border-left-color: var(--pinle-blue);">ğŸ” æ­·å²æŸ¥è©¢</div>
                <div class="input-group">
                    <input type="text" id="query-input" placeholder="è¼¸å…¥å®¢æˆ¶å§“åæœå°‹...">
                </div>
                <button class="btn btn-query" onclick="queryCustomer()">æœå°‹æ­·å¹´æ¶ˆè²»ç´€éŒ„</button>
                <div id="query-results" class="scroll-area">
                    <p style="text-align:center; color:#a0aec0; margin-top:20px;">è«‹è¼¸å…¥å§“åæœå°‹</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbw6PZqyrRqHscFdZHNTsKnVdpMl3Y7_oKDAEVlkHP6fLq885htw0HRe0HImSU7DU1xhww/exec"; 
    const firebaseConfig = { databaseURL: "https://mypos2026-2625d-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentCost = 0;
    let searchTimer; // â˜… ç”¨æ–¼å„ªåŒ–æœå°‹é »ç‡çš„è¨ˆæ™‚å™¨

    function initSystem() {
        document.getElementById('ord-date').valueAsDate = new Date();
        fetchParams();
        checkReminders();
    }

    function fetchParams() {
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "getParameters" }) })
        .then(res => res.json()).then(data => {
            const select = document.getElementById('income-type');
            if(data.incomeList) {
                select.innerHTML = data.incomeList.map(v => `<option value="${v}">${v}</option>`).join('');
            }
        });
    }

    function checkReminders() {
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "getReminders" }) })
        .then(res => res.json()).then(list => {
            if (list && list.length > 0) {
                document.getElementById('reminder-bar').style.display = 'block';
                document.getElementById('reminder-text').innerText = list.map(i => `${i.name}(${i.product})`).join('ã€');
            }
        });
    }

    // â˜… å„ªåŒ–å¾Œçš„æœå°‹é‚è¼¯ï¼šåªæœ‰åœæ­¢è¼¸å…¥ 0.5 ç§’å¾Œæ‰æœƒçœŸæ­£å»æŸ¥è³‡æ–™
    function fetchStockData() {
        const sn = document.getElementById('sale-sn').value.trim();
        const resName = document.getElementById('res-name');
        const resCost = document.getElementById('res-cost');
        const btn = document.getElementById('btn-checkout');

        if (sn.length < 5) {
            resName.innerText = "ç­‰å¾…è¼¸å…¥...";
            resCost.innerText = "$0";
            return;
        }

        clearTimeout(searchTimer);

        searchTimer = setTimeout(() => {
            resName.innerText = "ğŸ” æ­£åœ¨æŸ¥è©¢åº«å­˜...";
            
            db.ref('inventory/' + sn).once('value').then(snap => {
                if (snap.exists()) {
                    const d = snap.val();
                    if (d.soldTo) {
                        resName.innerHTML = `<span style="color:red;">âš ï¸ å·²å”®çµ¦ ${d.soldTo}</span>`;
                        btn.disabled = true;
                    } else {
                        resName.innerText = d.name;
                        resCost.innerText = "$" + d.cost;
                        currentCost = parseFloat(d.cost);
                        btn.disabled = false;
                    }
                    uiCalculate();
                } else {
                    fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "checkStock", sn: sn }) })
                    .then(res => res.json()).then(data => {
                        if (data && !data.error) {
                            resName.innerText = data.productName;
                            resCost.innerText = "$" + data.cost;
                            currentCost = parseFloat(data.cost);
                            btn.disabled = false;
                        } else {
                            resName.innerText = "âŒ æŸ¥ç„¡åºè™Ÿ";
                            btn.disabled = true;
                        }
                        uiCalculate();
                    });
                }
            });
        }, 500); 
    }

    function uiCalculate() {
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        const method = document.getElementById('pay-method').value;
        const isFee = !(["ç¾é‡‘", "åŒ¯æ¬¾", "iPass Money"].includes(method));
        const fee = isFee ? Math.round(price * 0.02) : 0;
        const profit = Math.round(price - currentCost - fee);

        document.getElementById('fee-note').innerText = isFee ? `ğŸ’¡ æ‰£ 2% æ‰‹çºŒè²»: $${fee}` : "âœ… å…æ‰‹çºŒè²»æ–¹å¼";
        document.getElementById('res-profit').innerText = "$" + profit.toLocaleString();
    }

    function submitCheckout() {
        const sn = document.getElementById('sale-sn').value;
        if(!sn) return alert("è«‹å…ˆè¼¸å…¥/æƒæåºè™Ÿ");
        
        const btn = document.getElementById('btn-checkout');
        btn.disabled = true;
        btn.innerText = "åŒæ­¥è‡³ Excel ä¸­...";

        const payload = {
            action: "checkout",
            date: new Date().toLocaleDateString('zh-TW'),
            incomeType: document.getElementById('income-type').value,
            payMethod: document.getElementById('pay-method').value,
            consumerName: document.getElementById('cust-name').value + " - " + document.getElementById('res-name').innerText,
            price: document.getElementById('sale-price').value,
            cost: currentCost,
            sn: sn,
            extraNote: document.getElementById('sale-note').value,
            staff: document.getElementById('staff').value
        };

        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.text()).then(msg => {
            alert(msg);
            location.reload();
        });
    }

    function submitOrder() {
        const name = document.getElementById('ord-name').value;
        const product = document.getElementById('ord-product').value;
        const pickup = document.getElementById('ord-pickup').value;
        if(!name || !product || !pickup) return alert("è«‹å¡«å¯«å§“åã€å“åèˆ‡å–è²¨æ—¥æœŸ");

        const payload = {
            action: "saveOrder",
            name: name,
            product: product,
            orderTime: document.getElementById('ord-date').value,
            pickupTime: pickup,
            note: document.getElementById('ord-note').value
        };

        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.text()).then(msg => {
            alert(msg);
            location.reload();
        });
    }

    function queryCustomer() {
        const name = document.getElementById('query-input').value;
        if (!name) return;
        document.getElementById('query-results').innerHTML = '<p style="text-align:center;">ğŸ” æœå°‹ä¸­...</p>';
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "queryCustomer", name: name }) })
        .then(res => res.json()).then(data => {
            if (!data || data.length === 0) {
                document.getElementById('query-results').innerHTML = '<p style="text-align:center; color:red;">æ‰¾ä¸åˆ°ç´€éŒ„</p>';
                return;
            }
            let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>é‡‘é¡</th></tr></thead><tbody>';
            data.forEach(r => {
                html += `<tr><td>${r.date}<br><small>${r.year}</small></td><td>${r.name}</td><td>$${Number(r.price).toLocaleString()}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('query-results').innerHTML = html;
        });
    }
</script>
</body>
</html>
