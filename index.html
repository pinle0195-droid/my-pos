var FIREBASE_URL = "https://mypos2026-2625d-default-rtdb.asia-southeast1.firebasedatabase.app/";

// ğŸš€ Firebase åŒæ­¥åŠŸèƒ½ (å°æ‡‰æ‚¨æˆªåœ–çš„æŒ‰éˆ•)
function syncAllSheetsToFirebase() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var stockSheets = ["æ‰‹æ©Ÿåº«å­˜è¡¨", "APPLEç©¿æˆ´.iPAD", "å®¶é›»å…¶ä»–"];
  var inventory = {};
  var count = 0;
  stockSheets.forEach(function(name) {
    var sheet = ss.getSheetByName(name);
    if (!sheet) return;
    var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5).getValues();
    data.forEach(function(row) {
      if (row[4]) {
        var sn = row[4].toString().replace(/[^a-zA-Z0-9]/g, "").trim();
        if (sn !== "") {
          inventory[sn] = { "name": row[1] || "æœªå‘½å", "cost": row[2] || 0 };
          count++;
        }
      }
    });
  });
  var options = { "method": "put", "contentType": "application/json", "payload": JSON.stringify(inventory) };
  UrlFetchApp.fetch(FIREBASE_URL + "inventory.json", options);
  Browser.msgBox("âœ… åº«å­˜åŒæ­¥æˆåŠŸï¼å…±ï¼š" + count + " ç­†");
}

// ğŸ›’ çµå¸³èˆ‡ ğŸ” æŸ¥è©¢æ ¸å¿ƒ
function doPost(e) {
  if (!e || !e.postData || !e.postData.contents) return;
  var data = JSON.parse(e.postData.contents);
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // å®¢æˆ¶æŸ¥è©¢ï¼šæƒææ‰€æœ‰å«ã€Œæµæ°´å¸³ã€å­—çœ¼çš„åˆ†é 
  if (data.action === "search") {
    var keyword = data.keyword ? data.keyword.toString().toLowerCase().trim() : "";
    var results = [];
    ss.getSheets().forEach(function(sheet) {
      if (sheet.getName().indexOf("æµæ°´å¸³") > -1) {
        var values = sheet.getDataRange().getValues();
        for (var i = 1; i < values.length; i++) {
          var buyer = String(values[i][4] || ""); // E æ¬„
          var note = String(values[i][7] || "");  // H æ¬„
          if (buyer.toLowerCase().indexOf(keyword) > -1 || note.toLowerCase().indexOf(keyword) > -1) {
            results.push({ date: values[i][0], name: buyer, price: values[i][5] || values[i][6] || 0, note: note, year: sheet.getName() });
          }
        }
      }
    });
    return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
  }

  // çµå¸³åŒæ­¥ï¼šç²¾ç¢ºå¡«å…¥å°æ‡‰æ¬„ä½
  if (data.action === "checkout") {
    var sheet = ss.getSheetByName("æµæ°´å¸³2026");
    sheet.appendRow([
      data.date,          // A æ—¥æœŸ
      "éŠ·å”®",             // B æ‘˜è¦
      "",                 // C
      data.payMethod,     // D æ–¹å¼
      data.consumerName,  // E å§“å-å“å
      data.nonCashAmt,    // F éç¾é‡‘
      data.cashAmt,       // G ç¾é‡‘
      data.note,          // H å‚™è¨»(åºè™Ÿ)
      "", "", "",         // I, J, K
      data.staff,         // L æ‰¿è¾¦äºº
      "",                 // M
      data.profit         // N é ä¼°æ¯›åˆ©
    ]);
    return ContentService.createTextOutput("Success");
  }
}
