<script>
    // Firebase èˆ‡ GAS é€£ç·šè¨­å®š
    const firebaseConfig = { databaseURL: "https://mypos2026-2625d-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const GOOGLE_SCRIPT_URL = "æ‚¨çš„æœ€æ–°éƒ¨ç½²ç¶²å€è²¼åœ¨é€™è£¡";

    let currentCost = 0;

    // åˆå§‹è¼‰å…¥
    function initAll() {
        loadParameters();
        checkReminders();
        document.getElementById('order-date').valueAsDate = new Date();
    }

    // å–å¾—åƒæ•¸
    function loadParameters() {
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getParameters" }) })
        .then(res => res.json()).then(data => {
            const inc = document.getElementById('income-type');
            inc.innerHTML = data.incomeList.map(v => `<option value="${v}">${v}</option>`).join('');
        });
    }

    // å–è²¨æé†’
    function checkReminders() {
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "getReminders" }) })
        .then(res => res.json()).then(list => {
            if (list && list.length > 0) {
                document.getElementById('reminder-bar').style.display = 'block';
                document.getElementById('reminder-text').innerText = list.map(item => `${item.name}(${item.product})`).join('ã€') + "ã€‚";
            }
        });
    }

    // è‡ªå‹•æŸ¥è©¢åº«å­˜ (æƒæè§¸ç™¼)
    window.autoFetch = () => {
        const sn = document.getElementById('sale-scan').value.trim();
        if (sn.length < 3) return;

        const resItem = document.getElementById('res-item');
        const resCost = document.getElementById('res-cost');
        const btnPay = document.getElementById('btn-pay-exec');

        // 1. å…ˆæŸ¥ Firebase
        db.ref('inventory/' + sn).once('value').then(snap => {
            if (snap.exists()) {
                const d = snap.val();
                if (d.soldTo) { 
                    resItem.innerHTML = `<span style="color:red;">âš ï¸ å·²å”®çµ¦ ${d.soldTo}</span>`; 
                    btnPay.disabled = true;
                } else { 
                    resItem.innerText = d.name; 
                    resCost.innerText = "$" + d.cost; 
                    currentCost = parseFloat(d.cost); 
                    btnPay.disabled = false; 
                }
                calculateProfit();
            } else { 
                // 2. Firebase æ‰¾ä¸åˆ°ï¼Œæ”¹æŸ¥ Excel
                resItem.innerText = "ğŸ” æª¢ç´¢ Excel ä¸­...";
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "checkStock", sn: sn })
                })
                .then(res => res.json())
                .then(data => {
                    if (data && !data.error) {
                        resItem.innerText = data.productName;
                        resCost.innerText = "$" + (data.cost || 0);
                        currentCost = parseFloat(data.cost) || 0;
                        btnPay.disabled = false;
                    } else {
                        resItem.innerText = "âŒ ç„¡æ­¤åº«å­˜"; 
                        btnPay.disabled = true;
                    }
                    calculateProfit();
                });
            }
        });
    };

    // è¨ˆç®—æ¯›åˆ©
    window.calculateProfit = () => {
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        const method = document.getElementById('pay-method').value;
        const isFee = !(["ç¾é‡‘", "åŒ¯æ¬¾", "iPass Money"].some(m => method.includes(m)));
        let fee = isFee ? price * 0.02 : 0;
        document.getElementById('fee-notice').innerText = fee > 0 ? "ğŸ’¡ æ‰£æ‰‹çºŒè²»: $" + Math.round(fee) : "âœ… å…æ‰‹çºŒè²»";
        document.getElementById('res-profit').innerText = "$" + Math.round(price - currentCost - fee).toLocaleString();
    };

    // åŸ·è¡Œçµå¸³
    window.executeCheckout = () => {
        const btn = document.getElementById('btn-pay-exec');
        btn.disabled = true; btn.innerText = "ğŸš€ åŒæ­¥ä¸­...";
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "checkout", date: new Date().toLocaleDateString('zh-TW'),
                payMethod: document.getElementById('pay-method').value,
                incomeType: document.getElementById('income-type').value,
                consumerName: document.getElementById('sale-buyer').value + " - " + document.getElementById('res-item').innerText,
                price: document.getElementById('sale-price').value, cost: currentCost, sn: document.getElementById('sale-scan').value,
                extraNote: document.getElementById('sale-note-extra').value, staff: document.getElementById('staff-select').value
            })
        }).then(res => res.text()).then(text => { alert(text); location.reload(); });
    };

    // å„²å­˜å®¢è¨‚
    window.saveOrder = () => {
        const name = document.getElementById('order-name').value;
        const product = document.getElementById('order-product').value;
        const pickup = document.getElementById('pickup-date').value;
        if (!name || !product || !pickup) { alert("è«‹å¡«å¯«å§“åã€å“åèˆ‡å–è²¨æ—¥æœŸ"); return; }
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "saveOrder", name: name, product: product,
                orderTime: document.getElementById('order-date').value,
                pickupTime: pickup, note: document.getElementById('order-note').value
            })
        }).then(res => res.text()).then(msg => { alert(msg); location.reload(); });
    };

    // å®¢æˆ¶æŸ¥è©¢
    window.searchCustomer = () => {
        const name = document.getElementById('query-name').value;
        if (!name) return;
        document.getElementById('query-results').innerHTML = '<p style="text-align: center;">ğŸ” æŸ¥è©¢ä¸­...</p>';
        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "queryCustomer", name: name }) })
        .then(res => res.json()).then(data => {
            if (!data || data.length === 0) { document.getElementById('query-results').innerHTML = '<p style="text-align: center; color: red;">æ‰¾ä¸åˆ°ç´€éŒ„</p>'; return; }
            let h = '<table><thead><tr><th>æ—¥æœŸ</th><th>å®¢æˆ¶/å“é …</th><th>é‡‘é¡</th></tr></thead><tbody>';
            data.forEach(r => h += `<tr><td>${r.date}<br><small>${r.year}</small></td><td><b>${r.name}</b></td><td>$${Number(r.price).toLocaleString()}</td></tr>`);
            document.getElementById('query-results').innerHTML = h + '</tbody></table>';
        });
    };
</script>
