<div class="form-group">
    <label>付款方式</label>
    <select id="pay-method" onchange="calculateProfit()">
        <option value="現金">現金</option>
        <option value="刷卡">刷卡 (2%手續費)</option>
        <option value="LP">LP (2%手續費)</option>
        <option value="分期">分期</option>
        <option value="行動支付">行動支付</option>
        <option value="匯款/ LPMoney/ iPass Money/電子支付">匯款/ LPMoney/ iPass Money/電子支付</option>
        <option value="無卡分期">無卡分期</option>
        <option value="電商匯款">電商匯款</option>
        <option value="帳期(未付)">帳期(未付)</option>
    </select>
</div>

<div class="form-group">
    <label>成交售價</label>
    <input type="number" id="sale-price" placeholder="請輸入金額" oninput="calculateProfit()">
</div>

<div id="profit-info" style="background:#fffcf0; padding:10px; border-radius:8px; font-size:14px; margin-bottom:15px; border:1px solid #ffeeba;">
    預估手續費：<span id="res-fee">$0</span><br>
    預估毛利：<b id="res-profit" style="color:#e74c3c;">$0</b>
</div>

<script>
    // 核心財務計算
    window.calculateProfit = function() {
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        const method = document.getElementById('pay-method').value;
        const cost = currentCost || 0; // currentCost 由條碼掃描帶出
        
        let fee = 0;
        // 刷卡跟LP的手續費成本是2%
        if (method === "刷卡" || method === "LP") {
            fee = price * 0.02;
        }
        
        const profit = price - cost - fee;
        
        document.getElementById('res-fee').innerText = "$" + Math.round(fee);
        document.getElementById('res-profit').innerText = "$" + Math.round(profit);
    };

    window.handlePay = function() {
        const sn = document.getElementById('sale-scan').value;
        const method = document.getElementById('pay-method').value;
        const price = parseFloat(document.getElementById('sale-price').value);
        const itemName = document.getElementById('res-item').innerText;
        const buyer = document.getElementById('sale-buyer').value;

        if(!price || !buyer) return alert("請填寫購買人與金額");

        const isCash = (method === "現金");
        const fee = (method === "刷卡" || method === "LP") ? price * 0.02 : 0;
        const profit = price - currentCost - fee;

        const payload = {
            date: new Date().toLocaleDateString('zh-TW'),
            incomeType: "手機(單購)", // 可根據實際情況調整
            expenseType: "",
            payMethod: method,
            consumerName: buyer + " - " + itemName,
            nonCashAmt: isCash ? "" : price,
            cashAmt: isCash ? price : "",
            note: "序號:" + sn + " | 毛利:" + Math.round(profit) + " | 手續費:" + Math.round(fee),
            staff: "思璇" // 預設人員
        };

        // 發送至 Google Sheets (請替換為您的部署 URL)
        fetch("YOUR_GOOGLE_SCRIPT_URL", {
            method: "POST",
            body: JSON.stringify(payload)
        }).then(() => {
            alert("結帳成功！Excel 紀錄與下拉選單已同步。");
            db.ref('inventory/' + sn).remove(); // 扣除庫存
            location.reload();
        });
    };
</script>
