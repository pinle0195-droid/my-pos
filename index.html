/**
 * å“æ¨‚é€šè¨Š POS ç³»çµ± - ç¸½èª¿åº¦å¾Œç«¯ (2026 æ•´åˆæœ€çµ‚ç‰ˆ)
 */

// ğŸ” LINE API è¨­å®š
var LINE_ACCESS_TOKEN = "13jVEWODdgJ/UYKWKlejTMGdbRa/vxExwz0a6ksr0yGHKiMAtLnE1U2DGAULUeB8C6SoJPE39i6UERNnK0iFvSVvSSNJngO7DC69m+6BQCvVlUZ/us7gAG4ZVgpWy4pnwos4Il4bQJ+bnvAoO+PapAdB04t89/1O/w1cDnyilFU=";
var LINE_USER_ID = "U97d368fe6b664d0389258509d5304811";

function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // --- 1. æŠ“å–åƒæ•¸è¡¨å…§å®¹ ---
  if (data.action === "getParameters") {
    var paramSheet = ss.getSheetByName("åƒæ•¸è¡¨");
    if (!paramSheet) return response("æ‰¾ä¸åˆ°åƒæ•¸è¡¨");
    var incomeValues = paramSheet.getRange("A1:A30").getValues().flat().filter(function(el) { return el !== "" && el !== null; });
    var expenseValues = paramSheet.getRange("B1:B20").getValues().flat().filter(function(el) { return el !== "" && el !== null; });
    return response({ incomeList: incomeValues, expenseList: expenseValues }, true);
  }

  // --- 2. åŸ·è¡Œçµå¸³å‹•ä½œ (å« 2% æ‰‹çºŒè²»èˆ‡åº«å­˜å›å¡«) ---
  if (data.action === "checkout") {
    var mainSheet = ss.getSheetByName("æµæ°´å¸³ 2026"); 
    if (!mainSheet) return response("æ‰¾ä¸åˆ°æµæ°´å¸³ 2026");
    var price = parseFloat(data.price) || 0;
    var cost = parseFloat(data.cost) || 0;
    var payMethod = data.payMethod;
    var isFeeMethod = !(["ç¾é‡‘", "åŒ¯æ¬¾", "iPass Money"].some(function(m) { return payMethod.indexOf(m) !== -1; }));
    var fee = isFeeMethod ? (price * 0.02) : 0;
    var profit = Math.round(price - cost - fee);
    var rowData = [
      data.date, data.incomeType, data.expenseType, data.payMethod, data.consumerName,
      (payMethod !== "ç¾é‡‘" ? price : ""), (payMethod === "ç¾é‡‘" ? price : ""), 
      data.extraNote, "", "", "", data.staff, "", profit
    ];
    mainSheet.appendRow(rowData);
    // åº«å­˜å›å¡«
    var searchSn = String(data.sn).trim().toLowerCase();
    if (searchSn !== "") {
      var targetSheets = ["æ‰‹æ©Ÿåº«å­˜è¡¨", "APPLEç©¿æˆ´.iPAD", "å®¶é›»å…¶ä»–"];
      for (var s = 0; s < targetSheets.length; s++) {
        var stockSheet = ss.getSheetByName(targetSheets[s]);
        if (!stockSheet) continue;
        var stockData = stockSheet.getDataRange().getValues();
        var found = false;
        for (var i = 1; i < stockData.length; i++) {
          if (String(stockData[i][4]).trim().toLowerCase() === searchSn) {
            stockSheet.getRange(i + 1, 6).setValue(data.date);
            stockSheet.getRange(i + 1, 8).setValue(data.consumerName);
            found = true; break;
          }
        }
        if (found) break;
      }
    }
    return response("æˆåŠŸåŒæ­¥è‡³ Excel");
  }

  // --- 3. å®¢æˆ¶æŸ¥è©¢åŠŸèƒ½ ---
  if (data.action === "queryCustomer") {
    var targetName = data.name ? data.name.toLowerCase() : "";
    var results = [];
    ss.getSheets().forEach(function(s) {
      if (s.getName().indexOf("æµæ°´å¸³") !== -1) {
        var rows = s.getDataRange().getValues();
        for (var i = 1
