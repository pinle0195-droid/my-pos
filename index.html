<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PINLE 3C | æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ç‰ˆ</title>
    <style>
        /* Cyberbiz æ·ºç¶ é¢¨æ ¼ */
        :root { --pinle-green: #52b788; --pinle-dark: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .card { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 8px solid var(--pinle-green); }
        
        h2, h3 { color: var(--pinle-dark); text-align: center; }
        .logo { color: var(--pinle-green); font-weight: bold; font-size: 24px; margin-bottom: 20px; display: block; text-align: center; }

        .form-group { margin-bottom: 15px; }
        label { font-size: 14px; font-weight: bold; color: #636e72; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* æœå°‹å»ºè­° */
        #sugg { display: none; background: #f1fcf7; padding: 10px; border-radius: 8px; margin-top: -10px; margin-bottom: 15px; }
        .tag { display: inline-block; background: white; color: var(--pinle-green); border: 1px solid var(--pinle-green); padding: 5px 12px; margin: 4px; border-radius: 20px; cursor: pointer; font-size: 14px; }

        /* æŸ¥è©¢çµæœè¡¨æ ¼ - ç…§ä½ æä¾›çš„ç‰ˆæœ¬é‚„åŸ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; font-size: 14px; }
        td { padding: 10px; border: 1px solid #ddd; font-size: 14px; text-align: center; }
        .sn-text { font-size: 11px; color: #7f8c8d; background: #eee; display: block; margin-top: 4px; padding: 2px; border-radius: 4px; }

        /* æŒ‰éˆ• */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; }
        .btn-pay { background-color: var(--pinle-green); }
        .btn-stock { background-color: var(--pinle-dark); margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <span class="logo">PINLE 3C</span>
    <h3>ğŸ” æœƒå“¡æ¶ˆè²»ç´€éŒ„æŸ¥è©¢</h3>
    
    <div class="form-group">
        <label>è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–å§“å (æ™ºæ…§å»ºè­°)</label>
        <input type="tel" id="search-phone" placeholder="ä¾‹å¦‚ï¼š0912345678 æˆ– å§“å" oninput="doSmartSearch()">
        <div id="sugg"></div>
        <button class="btn btn-pay" style="margin-top:10px;" onclick="searchMember()">å³æ™‚æŸ¥è©¢è³¼è²·ç´€éŒ„</button>
    </div>

    <div id="search-result" style="display:none; margin-top:20px;">
        <h4 id="display-name" style="color:var(--pinle-dark);">å®¢æˆ¶å§“åï¼š---</h4>
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>å“å</th>
                    <th>é‡‘é¡</th>
                </tr>
            </thead>
            <tbody id="member-history-table"></tbody>
        </table>
    </div>

    <hr style="margin: 30px 0; border: 0.5px solid #eee;">

    <h3>ğŸ“¦ é€²è²¨èˆ‡çµå¸³å…¥åº«</h3>
    <label>é€²è²¨/éŠ·å”®é¡å‹</label>
    <select id="item-type">
        <option value="é…ä»¶é€²è²¨">é…ä»¶ / å…¶ä»–å•†å“é€²è²¨</option>
        <option value="æ‰‹æ©Ÿé€²è²¨">æ‰‹æ©Ÿå•†å“é€²è²¨</option>
    </select>
    
    <input type="text" id="sn-code" placeholder="å•†å“åºè™Ÿ (IMEI/SN)">
    <input type="text" id="supplier-name" placeholder="é€²è²¨äºº / ä¾›æ‡‰å•†">
    <input type="text" id="item-name" placeholder="å“å">
    <input type="number" id="item-price" placeholder="é‡‘é¡">

    <button class="btn btn-stock" onclick="alert('é€²è²¨è¨˜éŒ„æˆåŠŸ')">ç¢ºèªè¨˜éŒ„ / é€²è²¨</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2cr8CgW6v19XhrnMC6eUX3Zo3WiE0824",
      authDomain: "mypos2026-2625d.firebaseapp.com",
      projectId: "mypos2026-2625d",
      databaseURL: "https://mypos2026-2625d-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // æ™ºæ…§æœå°‹å»ºè­°é‚è¼¯
    window.doSmartSearch = async function() {
        const val = document.getElementById('search-phone').value.trim();
        const sugg = document.getElementById('sugg');
        if(!val) { sugg.style.display = 'none'; return; }

        const snapshot = await get(ref(db, 'members'));
        if (snapshot.exists()) {
            const all = snapshot.val();
            const matches = Object.keys(all).filter(k => k.includes(val) || (all[k].name && all[k].name.includes(val)));
            if(matches.length > 0) {
                sugg.style.display = 'block';
                sugg.innerHTML = matches.slice(0, 5).map(m => `<span class="tag" onclick="selectTag('${m}')">${all[m].name || m}</span>`).join('');
            }
        }
    }

    window.selectTag = function(val) {
        document.getElementById('search-phone').value = val;
        document.getElementById('sugg').style.display = 'none';
        searchMember();
    }

    // é‚„åŸåŸæœ¬çš„æŸ¥è©¢å‡½æ•¸
    window.searchMember = async function() {
        const key = document.getElementById('search-phone').value;
        const tableBody = document.getElementById('member-history-table');
        const resultDiv = document.getElementById('search-result');

        if(!key) return alert("è«‹è¼¸å…¥é›»è©±æˆ–å§“å");

        const memberRef = ref(db, 'members/' + key);
        const snapshot = await get(memberRef);

        if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById('display-name').innerText = "å®¢æˆ¶å§“åï¼š" + (data.name || "æœªçŸ¥");
            
            let html = "";
            if(data.history) {
                // å°‡ç‰©ä»¶è½‰é™£åˆ—ä¸¦åè½‰ï¼Œé¡¯ç¤ºæœ€æ–°ç´€éŒ„
                const historyArray = Object.values(data.history);
                historyArray.reverse().forEach(item => {
                    html += `<tr>
                        <td>${item.date}</td>
                        <td>${item.item}${item.sn ? `<span class="sn-text">åºè™Ÿ: ${item.sn} (${item.supplier || 'é€²è²¨'})</span>` : ''}</td>
                        <td>$ ${item.price}</td>
                    </tr>`;
                });
            } else {
                html = "<tr><td colspan='3'>ç„¡è³¼è²·ç´€éŒ„</td></tr>";
            }
            tableBody.innerHTML = html;
            resultDiv.style.display = 'block';
        } else {
            alert("æ‰¾ä¸åˆ°è©²æœƒå“¡è³‡æ–™");
        }
    }
</script>

</body>
</html>
