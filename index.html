<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“æ¨‚ POS 2026 å„ªåŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --pinle-green: #2ecc71; --pinle-blue: #3498db; --pinle-orange: #e67e22; --bg-gray: #f4f7f6; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-gray); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--pinle-green); padding-left: 10px; }
        .main-flex { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-left { flex: 1.5; min-width: 350px; }
        .flex-right { flex: 1; min-width: 300px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .result-box { background: #fdfdfd; padding: 12px; border: 1px dashed #ccc; border-radius: 8px; margin-bottom: 12px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }
        .btn-pay { background: var(--pinle-green); }
        .btn-pay:disabled { background: #ccc; }
        #reminder-bar { display:none; background:#fff3cd; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; }
        .loading-text { color: #3498db; font-size: 0.8rem; }
    </style>
</head>
<body onload="initSystem()">

<div class="container">
    <div id="reminder-bar">ğŸ“… æ˜æ—¥å–è²¨ï¼š<span id="reminder-text"></span></div>
    
    <div class="main-flex">
        <div class="flex-left">
            <div class="card">
                <div class="card-title">ğŸ’° å¿«é€Ÿçµå¸³</div>
                <div class="input-group">
                    <label>æƒæåºè™Ÿ / SN <span id="scan-status" class="loading-text"></span></label>
                    <input type="text" id="sale-sn" placeholder="è¼¸å…¥åºè™Ÿå¾Œè‡ªå‹•æŸ¥è©¢..." oninput="debounceSearch()">
                </div>
                <div class="result-box">
                    <div style="display:flex; justify-content:space-between"><span>å“å:</span><b id="res-name">ç­‰å¾…è¼¸å…¥...</b></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>æˆæœ¬:</span><span id="res-cost">$0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px; color:var(--pinle-orange); font-weight:bold;">
                        <span>é ä¼°æ¯›åˆ©:</span><span id="res-profit">$0</span>
                    </div>
                </div>
                <div class="input-group"><label>å®¢æˆ¶å§“å</label><input type="text" id="cust-name"></div>
                <div class="input-group"><label>å”®åƒ¹</label><input type="number" id="sale-price" oninput="uiCalculate()"></div>
                <div class="input-group">
                    <label>æ”¯ä»˜æ–¹å¼</label>
                    <select id="pay-method" onchange="uiCalculate()">
                        <option value="ç¾é‡‘">ç¾é‡‘</option><option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                        <option value="åˆ·å¡">åˆ·å¡ (2%)</option><option value="LP">LP (2%)</option>
                        <option value="ç„¡å¡åˆ†æœŸ">ç„¡å¡åˆ†æœŸ (2%)</option>
                    </select>
                </div>
                <div class="input-group"><label>æ”¶å…¥é¡åˆ¥</label><select id="income-type"></select></div>
                <div class="input-group"><label>ç¶“æ‰‹äºº</label><select id="staff"><option>å¤éœ–</option><option>æ€ç’‡</option><option>å˜‰å°¹</option></select></div>
                <button id="btn-checkout" class="btn btn-pay" onclick="submitCheckout()">ç¢ºèªçµå¸³</button>
            </div>
        </div>

        <div class="flex-right">
            <div class="card">
                <div class="card-title" style="border-color:var(--pinle-orange)">ğŸ“¦ å•†å“å®¢è¨‚</div>
                <input type="text" id="ord-name" placeholder="å®¢æˆ¶å§“å" style="margin-bottom:10px;">
                <input type="text" id="ord-product" placeholder="ç”¢å“åç¨±" style="margin-bottom:10px;">
                <label>é è¨ˆå–è²¨</label>
                <input type="date" id="ord-pickup" style="margin-bottom:10px;">
                <button class="btn" style="background:var(--pinle-orange)" onclick="submitOrder()">å„²å­˜ä¸¦é€šçŸ¥ LINE</button>
            </div>
            
            <div class="card">
                <div class="card-title" style="border-color:var(--pinle-blue)">ğŸ” æ­·å²æŸ¥è©¢</div>
                <input type="text" id="query-input" placeholder="å®¢æˆ¶å§“å..." style="margin-bottom:10px;">
                <button class="btn" style="background:var(--pinle-blue)" onclick="queryCustomer()">æœå°‹ç´€éŒ„</button>
                <div id="query-results" style="margin-top:10px; font-size:0.85rem; max-height:200px; overflow:auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbw6PZqyrRqHscFdZHNTsKnVdpMl3Y7_oKDAEVlkHP6fLq885htw0HRe0HImSU7DU1xhww/exec"; 
    const firebaseConfig = { databaseURL: "https://mypos2026-2625d-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentCost = 0;
    let timer;

    function initSystem() {
        fetchParams();
        checkReminders();
    }

    // é˜²æŠ–æœå°‹ï¼šåœæ­¢è¼¸å…¥ 400ms å¾Œæ‰å•Ÿå‹•
    function debounceSearch() {
        clearTimeout(timer);
        document.getElementById('scan-status').innerText = "â³ è¼¸å…¥ä¸­...";
        timer = setTimeout(fetchStockData, 400);
    }

    function fetchStockData() {
        const sn = document.getElementById('sale-sn').value.trim();
        if (sn.length < 5) return;
        document.getElementById('scan-status').innerText = "ğŸ” æŸ¥è©¢ä¸­...";

        // å„ªå…ˆ Firebase
        db.ref('inventory/' + sn).once('value').then(snap => {
            if (snap.exists()) {
                handleStockResult(snap.val().soldTo ? {error: "å·²å”®çµ¦ " + snap.val().soldTo} : {productName: snap.val().name, cost: snap.val().cost});
            } else {
                // è½‰å‘ Excel
                fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "checkStock", sn: sn }) })
                .then(res => res.json()).then(handleStockResult);
            }
        });
    }

    function handleStockResult(data) {
        const btn = document.getElementById('btn-checkout');
        document.getElementById('scan-status').innerText = "";
        if (data && !data.error) {
            document.getElementById('res-name').innerText = data.productName;
            document.getElementById('res-cost').innerText = "$" + data.cost;
            currentCost = parseFloat(data.cost);
            btn.disabled = false;
        } else {
            document.getElementById('res-name').innerHTML = `<span style="color:red">${data.error || "æŸ¥ç„¡åºè™Ÿ"}</span>`;
            btn.disabled = true;
        }
        uiCalculate();
    }

    function uiCalculate() {
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        const method = document.getElementById('pay-method').value;
        const fee = !(["ç¾é‡‘", "åŒ¯æ¬¾", "iPass Money"].includes(method)) ? Math.round(price * 0.02) : 0;
        document.getElementById('res-profit').innerText = "$" + (price - currentCost - fee).toLocaleString();
    }

    function submitCheckout() {
        const btn = document.getElementById('btn-checkout');
        btn.disabled = true; btn.innerText = "å¯«å…¥ä¸­...";
        const payload = {
            action: "checkout",
            date: new Date().toLocaleDateString('zh-TW'),
            incomeType: document.getElementById('income-type').value,
            payMethod: document.getElementById('pay-method').value,
            consumerName: document.getElementById('cust-name').value + " - " + document.getElementById('res-name').innerText,
            price: document.getElementById('sale-price').value,
            cost: currentCost,
            sn: document.getElementById('sale-sn').value,
            staff: document.getElementById('staff').value
        };
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.text()).then(msg => { alert(msg); location.reload(); });
    }

    function fetchParams() {
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "getParameters" }) })
        .then(res => res.json()).then(data => {
            document.getElementById('income-type').innerHTML = data.incomeList.map(v => `<option value="${v}">${v}</option>`).join('');
        });
    }

    function checkReminders() {
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "getReminders" }) })
        .then(res => res.json()).then(list => {
            if (list.length > 0) {
                document.getElementById('reminder-bar').style.display = 'block';
                document.getElementById('reminder-text').innerText = list.map(i => i.name).join('ã€');
            }
        });
    }

    function submitOrder() {
        const payload = {
            action: "saveOrder",
            name: document.getElementById('ord-name').value,
            product: document.getElementById('ord-product').value,
            orderTime: new Date().toLocaleDateString('zh-TW'),
            pickupTime: document.getElementById('ord-pickup').value
        };
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.text()).then(msg => { alert(msg); location.reload(); });
    }

    function queryCustomer() {
        const name = document.getElementById('query-input').value;
        fetch(GOOGLE_URL, { method: "POST", body: JSON.stringify({ action: "queryCustomer", name: name }) })
        .then(res => res.json()).then(data => {
            let html = data.length ? '<table style="width:100%"><tr><th>æ—¥æœŸ</th><th>å“é …</th></tr>' : 'ç„¡ç´€éŒ„';
            data.forEach(r => html += `<tr><td>${r.date}</td><td>${r.name}</td></tr>`);
            document.getElementById('query-results').innerHTML = html + (data.length ? '</table>' : '');
        });
    }
</script>
</body>
</html>
